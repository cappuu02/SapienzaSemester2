La [[4) MAIF+SES Basic static analysis|Static Analysis]] consiste nell’analizzare un file malevolo **senza eseguirlo**, osservandone il codice, la struttura interna e i metadati. L’obiettivo è ottenere informazioni preliminari sul comportamento del malware in modo **sicuro** e **rapido**. 

```ad-danger
title: Problem
L'analisi statica può essere ingannevole in molti modi. Ne abbiamo appena mostrato uno, in cui si importa tutto a runtime.

Static Analysis gives you an approximation which might be made deliberately more coarse by the malware writer, who's gonna hide things from you.
```

# Dynamic Analysis
La _dynamic analysis_ consiste nell’**eseguire deliberatamente** il malware in un ambiente controllato, osservandone in tempo reale il comportamento. Permette di vedere **esattamente cosa fa il malware** quando è in esecuzione. Ovviamente si deve impedire che il malware si diffonda alle macchine di produzione.

>Le macchine reali possono essere isolate (ovvero non avere alcuna connessione di rete a Internet o ad altre macchine)

Static analysis can reach a dead-end, due to:
- Obfuscation (Nomi di funzioni o variabili rimossi, stringhe cifrate)
- Packing (Il codice malevolo è compresso o cifrato, viene decrittato solo in memoria)
- Examiner has exhausted the available static analysis technique

Dynamic analysis will show you exactly what the malware does.

```ad-success
title: Main Goal
Understand the malware behavior


```

Approaches: 
- ==Diffing==: Take a snapshot of a clean system state and a snapshot of a compromised system state. Compare before and after. (Tools = `regshot` and `autoruns`)
	- Pros: Artifacts can be observed easily
	- Cons: Can miss evidence that is created during malware activities and erased purposely by malware
- ==Monitoring==: From a clean system state, record every individual change in system, registry and network traffic that appears after executing the suspicious file (Tools: `procmon` and `Wireshark`)
	- Pros: Can collect all manifested changes
	- Cons: Often too much information and need to weed out irrelevant data
- ==API Tracing==: Hook and record important API calls made by the suspicious process (Tools: `Rohitab` `API Monitor`, `WinApiOverride`)
	- Pro:  Provides visibility into activity beyond the typical file/process/registry/network shown by other tools. Gets you a little closer to the type of interpretation that is required when doing static analysis
	- Cons: Often too much of information and need to weed out irrelevant data. API- specific interpretation can take a lot of time (but still less than static analysis ;))
- ==Debugging==: Set breakpoints inside the suspicious file to stop its execution at a given location and inspect its state. (Tools: `IDA`, `OllyDbg`, `Immunity Debugger`, `WinDbg`)
	- Pro: Provides a superset of the functionality of an API monitor
	- Cons: Typically must be be done in conjunction with some basic static analysis and assembly reading. Malware will often change its behavior or refuse to run when being debugged, which may require workarounds

```ad-abstract
title: Debugger
Tools that allow you to control the execution of a program at the level of individual instruction. 

```


**_BEHAVIORAL ANALYSIS TECHNIQUES_**
![[MW41.png|400]]

## Limits of Dynamic Analysis
- **Singolo percorso di esecuzione**: spesso si analizza una sola trace, non tutte le possibili esecuzioni.
- **Ambiente di analisi rilevabile**: il malware può individuare artefatti e cambiare comportamento.
- **Ambiente non esaustivo**: mancano risorse o condizioni reali (es. hardware o servizi specifici).
- **Scalabilità**: difficile automatizzare/analizzare in massa campioni complessi.

Come si esegue tecnicamente
Strumenti generali: _strumentazione_ del programma, del sistema operativo o dell’hardware.
### Program instrumentation (strumentazione del programma)
- L’analisi avviene **nello stesso address space** del sample.
- Tecniche:
    - **Debug manuale** (debugger, breakpoint, registri di debug).
    - **Hooking / API detours** (es. Detours su Windows).
    - **Modifica binaria**: rewrite di funzioni, inserimento di breakpoint.
- **Pro**: visibilità dettagliata delle chiamate/funzioni interne.
- **Contro**: non invisibile — facile da rilevare dal malware; richiede molto lavoro manuale.

### OS instrumentation (strumentazione del sistema operativo)
- L’analisi avviene sul **sistema operativo** che esegue il sample.
- Tecniche:
    - Hook di system call (es. Windows system call hooks).
- **Pro**: più trasparente rispetto al malware user-mode.
- **Contro**: problemi se il malware esegue codice in **kernel mode**; visibilità limitata all’interno del processo (es. non è semplice impostare breakpoint sulle funzioni interne).

### HW instrumentation (strumentazione hardware / emulazione)
- Fornisce un **hardware virtuale** (CPU) dove eseguire il sample, talvolta con un OS guest.
- Tecniche:
    - **Emulazione delle istruzioni** (software CPU emulator).
    - Osservazione “dall’esterno” delle interazioni.
- **Pro**: trasparente al sample e (spesso) al guest OS; non richiede modifica del binario.
- **Contro**: un ambiente minimale può essere rilevato; un ambiente completo è più lento.
- Nota: implementazioni tipiche → **sandboxes**
### Cosa vogliamo osservare (target dell’analisi)
- Il processo interagisce con l’ambiente tramite **system call**; monitorare le chiamate al SO è fondamentale per ricostruire il comportamento.
- Risorse da monitorare:
    - **File system**: create, read, write, open, delete, ecc.
    - **Registry** (Windows): chiavi lette/scritte.
    - **Servizi**: start/stop tramite Service Manager.
    - **Processi**: creazione/terminazione, injection, IPC.
    - **Rete**: chiamate API di rete e log dei pacchetti.

>Nota: molti **Native Windows system calls** non sono documentati e possono cambiare; gli sviluppatori dovrebbero usare le **Windows API** stabili, ma il malware può aggirare le API ufficiali.

### Output/Report tipico da dynamic analysis
- **File activity** — elenco operazioni su file (read/write/create/open...).
- **Registry activity** — modifiche e letture di chiavi.
- **Service activity** — avvio/arresto di servizi.
- **Process activity** — processi figli, terminazioni, IPC, injection.
- **Network activity** — chiamate di rete, domain/IP contattati, log di pacchetti.

### Checklist rapida per l’analista (ordine consigliato)
1. Preparare sandbox/VM con livello di trasparenza adeguato.
2. Avviare monitoring a livello OS (system call) + rete + file/registry.
3. Se necessario, applicare program instrumentation per dettagli interni.
4. Eseguire sample e raccogliere trace (log file, pcap, snapshot).
5. Analizzare artefatti per evasione (evidenze di detection dell’ambiente).
6. Redigere report con timeline, **IOCs** (file, chiavi, IP/domains) e raccomandazioni.

## SANDBOX
```ad-abstract
title: Definition
Sandbox is an all-in-one software for basic dynamic analysis for malwares.
It provides a virtualized environment that simulates network services and system components.

```

==Functionality==:
- Automatically executes the sample in an isolated and controlled environment.
- Monitors and records malware behavior (files, network, processes, registry).
- Can fully automate dynamic analysis.
- Generates detailed reports (often in PDF format) with analysis results.

**_Pros_**: Easy to use, good data visualization 
**_Con_**: Expensive professional software, Sandbox can be revealed by the malware

## Malware Classification
A nice byproduct of sandboxes is (tentative) family classification.
Naming conventions derived from Computer Antivirus Research Organization
(CARO) Malware Naming Scheme:

![[MW42.png]]
![[MW43.png]]

Classification schemes are hardly coherent:
![[MW44.png]]

## Real Machines
Disadvantages:  
- No Internet connection, so parts of the malware may not work
- Can be difficult to remove malware: re-imaging the machine will be necessary
Advantage:
- Some malware detects virtual machines and will not run properly in one

## Virtual Machines
The most common method because allow to protects the host machine from the malware.
- VM-escape attacks remain possible (but currently unlikely)
- Naive VM usage is way more dangerous
You can easily snapshot the VM and revert it to a clean state at the end of each analysis job

```ad-example
title: Example: Oracle Virtual Box
Can read/write VMware disks.
Reasonable performance for the goals of this course


```

### Configuring VM
You can disable networking by disconnecting the virtual network adapter while the VM is running.
Host-only networking allows network traffic to the host but not the Internet.

![[MW45.png]]

Obiviously, more complex setups are possible. Use ad-hoc networking to fake externals services. (Host-only networking)

![[MW46.png|400]]

### Snapshots
```ad-abstract
title: Definizione
Un **snapshot** è una **istantanea completa dello stato di una macchina virtuale** (RAM, disco, impostazioni, processi, ecc.) in un determinato momento.
Permette di **tornare rapidamente** a quello stato esatto in futuro.

```

Use snapshots to:
-  Protect a clean installation of the analysis environment
- Keep track of ongoing progress during analysis
- Hop instantly from job to job if you need to analyze several samples at the same time

>Lo snapshot è come un “**punto di salvataggio**” del sistema virtuale: utile per ripristinare, confrontare o ripetere un’analisi in modo rapido e sicuro.

![[MW47.png]]

### Risks of using a VM for malware analysis
Malware may detect that it is in a VM and run differently
Virtualization environments may have bugs: in some cases, malware may exploit it to spread and/or affect the host
All the samples we analyze in this course are harmless

## Windows
La maggior parte del malware incontra è **basato su Windows**; per questo si usa tipicamente una **VM con Windows 10** per le analisi dinamiche. Alcuni malware vecchi **potrebbero richiedere privilegi admin** per eseguire. Disabilita le protezioni interne (es. **Windows Defender**) per evitare che i sample vengano quarantinati/cancellati.

>Usa **gpedit.msc** per modificare le policy di sistema se necessario.


### Launching DLLS
I file **.exe** possono essere eseguiti direttamente, mentre le **.dll** no; per lanciare una DLL da riga di comando si può usare lo strumento di Windows `rundll32.exe`, con la sintassi:

```bash
rundll32.exe DLLname,Export arguments
```

`Export` è il nome di una funzione esportata (ottenibile con Dependency Walker, PEview o PE Explorer). Molte DLL malevole però **non** espongono export — le tecniche di esecuzione alternative saranno trattate nel laboratorio pratico del corso.

### Process Monitors
- Monitors registry, file system, network, process, and thread activity
- All recorded events are kept, but you can filter the display to make it easier to find items of interest
- Do not run it too long or it will fill up all RAM and crash the machine

#### Process Monitors Toolbar
![[MW48.png]]

#### Filtering with exclude
Una tecnica consiste nel **nascondere l'attività normale** (rumore) prima di lanciare il malware: in pratica si escludono manualmente i processi legittimi dal log in modo da mettere in evidenza le azioni del sample. Per farlo, clicca col tasto destro sul **Process Name** desiderato e seleziona **Exclude**; ripeti per tutti i processi "rumorosi" prima di avviare l'esecuzione del malware.

![[MW49.png|500]]

#### Process Explorer
![[MW50.png|500]]

**_Legenda_**:
- Services are <mark style="background: #FFB8EBA6;">pink</mark>
- Processes are <mark style="background: #ADCCFFA6;">blue</mark>
- New processes are <mark style="background: #BBFABBA6;">green</mark> briefly
- Terminated processes are <mark style="background: #FF5582A6;">red</mark>

Info on loaded DLLs is available:
![[MW51.png|500]]

**_PROPERTIES_**
The **Properties** section shows the **DEP** and **ASLR** status for the file. The **Verify** button checks the file's **signature** on disk, but does not verify the image in memory: therefore, it does not detect techniques such as **process replacement** (when code in memory has been replaced after loading).

![[MW52.png|500]]

**_Strings_**
Compare Image to Memory strings, if they are very different, it can indicate process replacement

## Detecting malicious Documents
Open the document (e.g. PDF) on a system with a vulnerable application (e.g., an old version of Adobe Reader). Watch Process Explorer to see if it launches a process. The Image tab of the Properties sheet for that process will show where the malware is

## The Registry
Repository for configuration and control of Windows systems
System-wide
- Which device drivers to load, how to configure memory manager, process manager, etc.
- Applications read system-wide settings
Per-user settings
- Per-user preferences
- Most-recently accessed documents

Registry key is a container consisting of other keys (subkeys) or values
Registry value stores data whose type can be REG_SZ, REG_DWORD, REG_BINARY, etc.

![[MW53.png]]

REG_LINK
- HKEY_CURRENT_USER is a link to HKEY_USERS\Security ID (SID) of current user
- HKEY_CURRENT_CONFIG is a link to HKLM\SYSTEM\CurrentControlSet\Hardware Profiles\Current
- HKLM\SYSTEM\CurrentControlSet is a link to HKLM\SYSTEM\ControlSet00X, where X is a number
Registry Hive
- “Logical group of keys, subkeys and values in the registry that has a set of supporting files containing backups of its data”
- HKLM\SAM is stored in c:\windows\system32\config\SAM
- Or constructed dynamically in memory

### Regshot
Useful to check how a process modified the registry!
![[MW54.png]]

### Persistence
Persistence is a techniques to survive after reboot
- registry key
- File system
	- startup locations 
	- DLL search order hijacking
	- Trojanizing system files
- Master Boot Record (MBR)
- Basic Input/Output System (BIOS)

### Frequently Used Registry Key
![[MW55.png]]


### Persistence Using File System
Startup locations
- For the logged-in user: `%USERPROFILE%\Start Menu\Programs\Startup`
- For all users: `%ALLUSERSPROFILE%\Start Menu\Programs\Startup`

### Microsoft Windows Services
I **Windows Services** sono eseguibili a lunga durata che operano **senza interazione dell’utente**, simili ai daemon nei sistemi _nix_. Possono essere **avviati automaticamente** all’accensione del computer. Per registrare un servizio si usa la **Windows API `CreateService()`**; i servizi registrati si trovano nel registro sotto:
```
HKLM\System\CurrentControlSet\Services

```

### SVCHOST
`C:\Windows\System32\svchost.exe` è il **processo host generico** che carica ed esegue **servizi implementati come DLL**; sul sistema girano spesso **più istanze**, ciascuna responsabile di un gruppo di servizi (i gruppi sono elencati in `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Svchost`). È comune che malware si mascherino con il nome `svchost.exe` ma vengano eseguiti da percorsi diversi da `C:\Windows\System32` (es. `C:\Windows`) oppure che aggiungano una DLL per essere caricati dalla vera istanza di `svchost`.

## Packet Sniffing with Wireshark
![[MW56.png|600]]

### Follow TCP Stream
Can save files from streams here too:
![[MW57.png]]

### Using ApateDNS to redirect DNS Resolutions
![[MW58.png]]
## Monitoring with NCAT (Including NMAP)
![[MW59.png]]
## INETSIM
![[MW60.png]]
## INETSIM FOOLS A BROWSER
![[MW61.png]]
## INETSIM FOOLS NMAP
![[MW62.png]]
## Using the tools
Per analizzare il malware si utilizzano diversi strumenti:
- **Procmon**: filtrare per il nome dell’eseguibile del malware e **cancellare tutti gli eventi** appena prima di eseguirlo.
- **Process Explorer**: monitoraggio dei processi in esecuzione.
- **Regshot**: confronto dello stato del registro prima e dopo l’esecuzione del malware.
- **Virtual Network** con **ApateDNS** o **INetSim**: simulazione dei servizi di rete per osservare il comportamento del malware.
- **Wireshark**: cattura e analisi del traffico di rete generato dal sample.